################################################################################
#          PROBLÃˆME DÃ‰TECTÃ‰: URI PRINCIPAL INCORRECT                           #
################################################################################

SITUATION ACTUELLE
==================

Votre diagnostic a rÃ©vÃ©lÃ©:
  âœ“ 1 carnet d'adresses existe
  âœ“ 2 calendriers existent
  âœ— Utilisateur crÃ©Ã© avec une URI incorrecte

PROBLÃˆME:
  L'utilisateur a Ã©tÃ© crÃ©Ã© comme: principals/Olivier
  Il devrait Ãªtre: principals/users/olivier/

CONSÃ‰QUENCE:
  Les URLs CalDAV standards ne fonctionnent pas dans Thunderbird

QUE S'EST-IL PASSÃ‰ ?
====================

BaÃ¯kal a crÃ©Ã© l'utilisateur "Olivier" avec un chemin incorrect.
Cela peut arriver si:
  - Installation ou mise Ã  jour de BaÃ¯kal a eu un problÃ¨me
  - Configuration incorrecte dans l'interface admin
  - Base de donnÃ©es migrÃ©e d'une ancienne version

Ã‰TAPE 1: DIAGNOSTIC COMPLET
============================

Avant de corriger, voir EXACTEMENT ce qui existe:

cd ~/baikal-install
chmod +x diagnose_all_principals.sh
sudo ./diagnose_all_principals.sh

Ce script affiche:
  âœ“ TOUS les principals (utilisateurs)
  âœ“ TOUS les calendriers avec leurs URIs
  âœ“ Toutes les variantes d'URLs possibles Ã  tester
  âœ“ Les commandes curl pour tester chaque URL

RÃ‰SULTAT ATTENDU:

Principal URI: principals/Olivier  â† Incorrect !
  Type: Principal non-standard âš 

ğŸ“… Calendrier ID 1
  URI: calendars/Olivier/default/
  Nom: Mon Calendrier
  Principal: principals/Olivier
  URL CalDAV possible 1: https://caldav.maison-oadf.ddns.net/dav.php/calendars/Olivier/default/
  URL CalDAV possible 2: https://caldav.maison-oadf.ddns.net/dav.php/calendars/Olivier/default/
  URL CalDAV possible 3: https://caldav.maison-oadf.ddns.net/dav.php/principals/Olivier/calendars/default/

VOUS AVEZ 3 OPTIONS
===================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPTION 1: TESTER LES URLS ALTERNATIVES (RAPIDE - 5 min)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Le diagnostic affiche plusieurs variantes d'URLs possibles.
Certaines peuvent fonctionner mÃªme avec l'URI incorrecte !

Ã‰TAPES:
1. Lancer: sudo ./diagnose_all_principals.sh
2. Noter toutes les "URL CalDAV possible" affichÃ©es
3. Dans Thunderbird, essayer chaque URL une par une
4. Celle qui fonctionne = utiliser cette URL !

AVANTAGES:
  âœ“ Rapide (5 minutes)
  âœ“ Ne touche pas Ã  la base de donnÃ©es
  âœ“ Pas de risque

INCONVÃ‰NIENTS:
  âœ— URLs non-standard
  âœ— Peut ne pas fonctionner
  âœ— ProblÃ¨me persiste pour d'autres clients

COMMANDES DE TEST:
Le script fournit des commandes curl pour tester chaque URL:

curl -u 'Olivier:votre_password' -X PROPFIND -H 'Depth: 1' \
  'https://caldav.maison-oadf.ddns.net/dav.php/calendars/Olivier/default/'

Si cette commande retourne du XML â†’ L'URL fonctionne !
Si elle retourne 404 â†’ Essayer la variante suivante

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPTION 2: CORRIGER LA BASE DE DONNÃ‰ES (MOYEN - 10 min)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Corriger automatiquement l'URI du principal dans la base de donnÃ©es.

Ã‰TAPES:
1. Lancer: sudo ./fix_principal_uri.sh
2. Confirmer l'opÃ©ration
3. Le script va:
   - CrÃ©er un backup de la base
   - Corriger principals/Olivier â†’ principals/users/olivier/
   - Mettre Ã  jour tous les calendriers et carnets d'adresses
   - VÃ©rifier l'intÃ©gritÃ©
   - RedÃ©marrer les services
4. Les nouvelles URLs seront affichÃ©es

EXEMPLE DE RÃ‰SULTAT:
  Ancien: principals/Olivier
  Nouveau: principals/users/olivier/
  
  Nouvelle URL CalDAV:
  https://caldav.maison-oadf.ddns.net/dav.php/calendars/olivier/default/

AVANTAGES:
  âœ“ URLs standard et propres
  âœ“ Compatible avec tous les clients CalDAV
  âœ“ Backup automatique avant modification
  âœ“ Restauration automatique si Ã©chec

INCONVÃ‰NIENTS:
  âœ— Modification directe de la base (risque faible)
  âœ— Nom d'utilisateur converti en minuscules
  âœ— Il faudra reconfigurer Thunderbird avec la nouvelle URL

IMPORTANT:
  - Le nom d'utilisateur sera converti en minuscules (olivier)
  - Tous les calendriers et carnets seront mis Ã  jour
  - Un backup complet est crÃ©Ã© avant toute modification
  - Si problÃ¨me, restauration automatique du backup

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPTION 3: RECRÃ‰ER L'UTILISATEUR (PROPRE - 15 min)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Supprimer et recrÃ©er l'utilisateur correctement dans BaÃ¯kal.

Ã‰TAPES:

1. EXPORTER LES DONNÃ‰ES (si vous avez des Ã©vÃ©nements importants)
   - Connecter Thunderbird avec une URL alternative (Option 1)
   - Exporter tous les Ã©vÃ©nements (.ics)
   - Sauvegarder

2. SUPPRIMER L'UTILISATEUR ACTUEL
   - Aller sur https://caldav.maison-oadf.ddns.net/admin/
   - Utilisateurs & Ressources
   - Supprimer "Olivier"
   - Confirmer la suppression

3. CRÃ‰ER UN NOUVEL UTILISATEUR
   - Cliquer sur "+ Ajouter un utilisateur"
   - Remplir:
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Utilisateur: olivier  â† MINUSCULES ! â”‚
     â”‚ Nom complet: Olivier                 â”‚
     â”‚ Email: olivier@example.com           â”‚
     â”‚ Mot de passe: ************           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   - Enregistrer

4. VÃ‰RIFIER L'URI
   - L'URI doit Ãªtre: principals/users/olivier/
   - Pour vÃ©rifier: sudo ./list_baikal_users_calendars.sh

5. CRÃ‰ER UN CALENDRIER
   - Cliquer sur l'utilisateur
   - Section "Calendriers" â†’ "+ Ajouter un calendrier"
   - URI: default
   - Nom: Mon Calendrier
   - Enregistrer

6. URL FINALE
   https://caldav.maison-oadf.ddns.net/dav.php/calendars/olivier/default/

7. IMPORTER LES DONNÃ‰ES (si sauvegardÃ©es)
   - Configurer Thunderbird avec la nouvelle URL
   - Importer les Ã©vÃ©nements .ics

AVANTAGES:
  âœ“ Configuration 100% propre et standard
  âœ“ Aucun risque pour la base de donnÃ©es
  âœ“ Garantit la compatibilitÃ© future

INCONVÃ‰NIENTS:
  âœ— Plus long (15 minutes)
  âœ— Perte des donnÃ©es si pas de backup
  âœ— Reconfiguration complÃ¨te nÃ©cessaire

RECOMMANDATIONS POUR CHAQUE SITUATION
======================================

SI VOUS AVEZ PEU D'Ã‰VÃ‰NEMENTS (0-10):
  â†’ OPTION 3 (RecrÃ©er)
  Raison: Plus rapide que de dÃ©bugger, configuration propre garantie

SI VOUS AVEZ BEAUCOUP D'Ã‰VÃ‰NEMENTS (100+):
  â†’ OPTION 2 (Corriger la base)
  Raison: Ã‰vite de perdre/rÃ©importer toutes les donnÃ©es

SI VOUS VOULEZ JUSTE TESTER RAPIDEMENT:
  â†’ OPTION 1 (URLs alternatives)
  Raison: 5 minutes, aucun risque, peut suffire

SI VOUS ÃŠTES Ã€ L'AISE AVEC LA LIGNE DE COMMANDE:
  â†’ OPTION 2 (Corriger la base)
  Raison: Solution technique Ã©lÃ©gante avec backup automatique

SI VOUS PRÃ‰FÃ‰REZ L'INTERFACE GRAPHIQUE:
  â†’ OPTION 3 (RecrÃ©er)
  Raison: Tout se fait dans l'interface admin de BaÃ¯kal

NOTRE RECOMMANDATION
====================

Pour votre cas (2 calendriers existants, possiblement peu d'Ã©vÃ©nements):

1. ESSAYEZ D'ABORD: Option 1 (URLs alternatives)
   - Rapide, sans risque
   - Peut suffire pour Thunderbird
   - Si Ã§a ne fonctionne pas â†’ passez Ã  l'option 2

2. SI OPTION 1 NE FONCTIONNE PAS: Option 2 (Corriger la base)
   - Backup automatique
   - Correction propre
   - URLs standard
   - Si problÃ¨me â†’ Option 3

3. EN DERNIER RECOURS: Option 3 (RecrÃ©er)
   - Si Options 1 et 2 Ã©chouent
   - Configuration garantie propre

COMMANDES RAPIDES
=================

# Diagnostic complet
sudo ./diagnose_all_principals.sh

# Option 1: Voir les URLs alternatives dans le rÃ©sultat du diagnostic ci-dessus

# Option 2: Corriger automatiquement
sudo ./fix_principal_uri.sh

# Option 3: VÃ©rifier aprÃ¨s recrÃ©ation
sudo ./list_baikal_users_calendars.sh

# Test curl d'une URL
curl -u 'utilisateur:password' -X PROPFIND -H 'Depth: 1' \
  'https://caldav.maison-oadf.ddns.net/dav.php/calendars/utilisateur/calendrier/'

APRÃˆS LA CORRECTION
===================

Quelle que soit l'option choisie:

1. VÃ©rifier la nouvelle URL:
   sudo ./list_baikal_users_calendars.sh

2. Tester avec curl:
   curl -u 'olivier:password' -X PROPFIND -H 'Depth: 1' \
     'https://caldav.maison-oadf.ddns.net/dav.php/calendars/olivier/default/'

3. Configurer Thunderbird:
   - Supprimer l'ancien calendrier
   - Ajouter un nouveau avec la bonne URL
   - VÃ©rifier "Lecture et Ã©criture"

4. CrÃ©er un Ã©vÃ©nement de test

5. VÃ©rifier la synchronisation

FICHIERS DISPONIBLES
====================

diagnose_all_principals.sh   â†’ Diagnostic complet avec toutes les URLs
fix_principal_uri.sh         â†’ Correction automatique de la base
list_baikal_users_calendars.sh  â†’ VÃ©rification aprÃ¨s correction
CREATE_CALENDAR_GUIDE.txt    â†’ Guide de crÃ©ation d'utilisateur
THUNDERBIRD_CALDAV_GUIDE.txt â†’ Configuration Thunderbird

PRÃ‰VENTION FUTURE
=================

Pour Ã©viter ce problÃ¨me Ã  l'avenir:

âœ“ Toujours utiliser des identifiants en MINUSCULES
âœ“ VÃ©rifier l'URI aprÃ¨s crÃ©ation: sudo ./list_baikal_users_calendars.sh
âœ“ Tester avec curl avant de configurer les clients
âœ“ Conserver les backups rÃ©guliers

================================================================================

DÃ‰MARRER MAINTENANT
===================

Commencez par le diagnostic complet:

  sudo ./diagnose_all_principals.sh

Ce script vous montrera EXACTEMENT ce qui existe et toutes les URLs possibles
Ã  tester. Ensuite, choisissez l'option qui vous convient le mieux !

================================================================================
