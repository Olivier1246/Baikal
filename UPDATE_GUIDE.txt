################################################################################
#                      GUIDE DE MISE Ã€ JOUR BAÃKAL                             #
################################################################################

Ce guide explique comment mettre Ã  jour BaÃ¯kal vers une nouvelle version en
utilisant le script automatisÃ© ou manuellement.

================================================================================
MÃ‰THODE 1: MISE Ã€ JOUR AUTOMATIQUE (RECOMMANDÃ‰E)
================================================================================

Le script update_baikal.sh automatise entiÃ¨rement le processus de mise Ã  jour.

FONCTIONNALITÃ‰S:
---------------
âœ“ RÃ©cupÃ¨re automatiquement toutes les versions depuis GitHub
âœ“ Affiche les versions stables et prÃ©-releases
âœ“ CrÃ©e un backup automatique avant mise Ã  jour
âœ“ PrÃ©serve vos donnÃ©es (calendriers, contacts, configuration)
âœ“ VÃ©rifie l'installation aprÃ¨s mise Ã  jour
âœ“ Permet un rollback en cas de problÃ¨me

UTILISATION:
-----------
cd ~/baikal-install
chmod +x update_baikal.sh
sudo ./update_baikal.sh

Ã‰TAPES DU SCRIPT:
----------------
1. VÃ©rification de l'installation actuelle
2. Affichage de la version actuelle
3. RÃ©cupÃ©ration des versions disponibles depuis GitHub
4. Affichage de toutes les releases (stables et prÃ©-releases)
5. SÃ©lection de la version Ã  installer
6. Confirmation
7. CrÃ©ation d'un backup complet
8. TÃ©lÃ©chargement de la nouvelle version
9. ArrÃªt des services (Nginx, PHP-FPM)
10. Installation de la nouvelle version
11. PrÃ©servation des donnÃ©es (Specific/ et config/)
12. Restauration des permissions
13. RedÃ©marrage des services
14. VÃ©rification de l'installation
15. Rapport final

EXEMPLE D'UTILISATION:
---------------------
$ sudo ./update_baikal.sh

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         MISE Ã€ JOUR DE BAÃKAL                            â•‘
â•‘         Version automatique depuis GitHub                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Version actuelle de BaÃ¯kal: 0.9.4

[INFO] RÃ©cupÃ©ration des versions disponibles depuis GitHub...
[INFO] Releases rÃ©cupÃ©rÃ©es avec succÃ¨s

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Versions disponibles
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Version actuelle : 0.9.4

 1. 0.9.5         [STABLE]
    Nom: 0.9.5
    Date: 15/10/2024

 2. 0.9.4         [STABLE] [ACTUELLE]
    Nom: 0.9.4
    Date: 01/08/2024

 3. 0.9.3         [STABLE]
    Nom: 0.9.3
    Date: 15/05/2024

Choisissez une version Ã  installer (1-3) ou 'q' pour quitter: 1

Version sÃ©lectionnÃ©e:
  Version: 0.9.5
  Nom: 0.9.5
  Date: 15/10/2024

âš  ATTENTION âš 
Cette opÃ©ration va:
  1. CrÃ©er un backup complet
  2. ArrÃªter Nginx et PHP-FPM
  3. Installer BaÃ¯kal 0.9.5
  4. RedÃ©marrer les services

Voulez-vous continuer? (o/n): o

[Ã‰TAPE] CrÃ©ation d'un backup de sÃ©curitÃ©...
[INFO] Sauvegarde de l'installation actuelle...
[INFO] Backup crÃ©Ã©: /var/backups/baikal/upgrade/baikal_pre_upgrade_20241224_120000.tar.gz (5.2M)

[Ã‰TAPE] TÃ©lÃ©chargement de BaÃ¯kal 0.9.5...
[INFO] TÃ©lÃ©chargement terminÃ©

[Ã‰TAPE] Installation de la nouvelle version...
[INFO] ArrÃªt des services...
[INFO] Installation de la nouvelle version...
[INFO] Restauration des donnÃ©es utilisateur...
[INFO] Configuration des permissions...
[INFO] RedÃ©marrage des services...

[Ã‰TAPE] VÃ©rification de l'installation...
[INFO] Serveur web rÃ©pond correctement (HTTP 200)
[INFO] Nouvelle version installÃ©e: 0.9.5

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MISE Ã€ JOUR TERMINÃ‰E
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Version prÃ©cÃ©dente: 0.9.4
Nouvelle version: 0.9.5

Backup disponible dans:
  /var/backups/baikal/upgrade/baikal_pre_upgrade_20241224_120000.tar.gz

================================================================================
VÃ‰RIFICATION RAPIDE DES MISES Ã€ JOUR
================================================================================

Pour vÃ©rifier rapidement si une mise Ã  jour est disponible sans installer:

cd ~/baikal-install
chmod +x check_updates.sh
sudo ./check_updates.sh

Affiche:
- Version actuelle
- DerniÃ¨re version stable disponible
- Si une mise Ã  jour est nÃ©cessaire

================================================================================
MÃ‰THODE 2: MISE Ã€ JOUR MANUELLE
================================================================================

Si vous prÃ©fÃ©rez une mise Ã  jour manuelle, voici les Ã©tapes dÃ©taillÃ©es.

PRÃ‰REQUIS:
---------
âœ“ AccÃ¨s root au serveur
âœ“ Backup rÃ©cent des donnÃ©es
âœ“ Nouvelle version tÃ©lÃ©chargÃ©e

Ã‰TAPES DÃ‰TAILLÃ‰ES:
-----------------

1. CRÃ‰ER UN BACKUP COMPLET
   -------------------------
   cd /var/backups/baikal
   sudo tar -czf baikal_backup_$(date +%Y%m%d).tar.gz /var/www/baikal
   
   # Backup de la config Nginx
   sudo cp /etc/nginx/sites-available/baikal baikal_nginx_$(date +%Y%m%d).conf
   
   # VÃ©rifier le backup
   ls -lh baikal_backup_*.tar.gz

2. TÃ‰LÃ‰CHARGER LA NOUVELLE VERSION
   --------------------------------
   cd /tmp
   wget https://github.com/sabre-io/Baikal/releases/download/0.9.5/baikal-0.9.5.zip
   
   # VÃ©rifier le tÃ©lÃ©chargement
   ls -lh baikal-*.zip

3. ARRÃŠTER LES SERVICES
   ---------------------
   sudo systemctl stop nginx php*-fpm

4. SAUVEGARDER LES DONNÃ‰ES UTILISATEUR
   ------------------------------------
   cd /var/www/baikal
   sudo cp -r Specific /tmp/Specific_backup
   sudo cp -r config /tmp/config_backup

5. SUPPRIMER L'ANCIENNE INSTALLATION
   ----------------------------------
   cd /var/www/baikal
   sudo find . -mindepth 1 -maxdepth 1 ! -name 'Specific' ! -name 'config' -exec rm -rf {} +

6. EXTRAIRE LA NOUVELLE VERSION
   -----------------------------
   cd /tmp
   unzip baikal-0.9.5.zip
   sudo cp -r baikal/* /var/www/baikal/

7. RESTAURER LES DONNÃ‰ES UTILISATEUR
   ----------------------------------
   sudo rm -rf /var/www/baikal/Specific
   sudo rm -rf /var/www/baikal/config
   sudo cp -r /tmp/Specific_backup /var/www/baikal/Specific
   sudo cp -r /tmp/config_backup /var/www/baikal/config

8. CORRIGER LES PERMISSIONS
   -------------------------
   sudo chown -R www-data:www-data /var/www/baikal
   sudo chmod -R 755 /var/www/baikal
   sudo chmod -R 770 /var/www/baikal/Specific
   sudo chmod -R 770 /var/www/baikal/config

9. REDÃ‰MARRER LES SERVICES
   ------------------------
   sudo systemctl start php*-fpm
   sudo systemctl start nginx
   
   # VÃ©rifier les services
   sudo systemctl status nginx php*-fpm

10. VÃ‰RIFIER L'INSTALLATION
    -----------------------
    # Test HTTP
    curl http://localhost/
    
    # VÃ©rifier les logs
    sudo tail -f /var/log/nginx/baikal_error.log

11. NETTOYER LES FICHIERS TEMPORAIRES
    ----------------------------------
    cd /tmp
    rm -rf baikal baikal-*.zip
    rm -rf Specific_backup config_backup

================================================================================
ROLLBACK EN CAS DE PROBLÃˆME
================================================================================

Si la mise Ã  jour Ã©choue ou cause des problÃ¨mes, restaurez le backup:

AVEC LE SCRIPT AUTOMATIQUE:
--------------------------
Le script propose automatiquement un rollback en cas d'Ã©chec.
Le backup est situÃ© dans /var/backups/baikal/upgrade/

RESTAURATION MANUELLE:
---------------------
# 1. ArrÃªter les services
sudo systemctl stop nginx php*-fpm

# 2. Supprimer l'installation problÃ©matique
sudo rm -rf /var/www/baikal

# 3. Restaurer le backup
cd /var/backups/baikal
sudo tar -xzf baikal_backup_YYYYMMDD.tar.gz -C /

# 4. VÃ©rifier les permissions
sudo chown -R www-data:www-data /var/www/baikal

# 5. RedÃ©marrer les services
sudo systemctl start php*-fpm nginx

# 6. VÃ©rifier
curl http://localhost/
sudo systemctl status nginx php*-fpm

================================================================================
TESTS APRÃˆS MISE Ã€ JOUR
================================================================================

VÃ‰RIFICATIONS Ã€ EFFECTUER:
-------------------------

1. INTERFACE WEB
   âœ“ AccÃ¨s Ã  http://votre-serveur/
   âœ“ Connexion Ã  l'admin
   âœ“ Liste des utilisateurs visible
   âœ“ Liste des calendriers/contacts visible

2. LOGS
   âœ“ Aucune erreur dans /var/log/nginx/baikal_error.log
   âœ“ Aucune erreur dans journalctl -u nginx -u php*-fpm

3. SERVICES
   âœ“ Nginx actif: systemctl is-active nginx
   âœ“ PHP-FPM actif: systemctl is-active php*-fpm

4. PERMISSIONS
   âœ“ Specific/ accessible en Ã©criture par www-data
   âœ“ config/ accessible en Ã©criture par www-data

5. SYNCHRONISATION
   âœ“ Test avec un client (iOS, Android, Desktop)
   âœ“ CrÃ©ation d'un nouvel Ã©vÃ©nement/contact
   âœ“ Modification d'un Ã©vÃ©nement/contact existant
   âœ“ Synchronisation entre plusieurs appareils

6. BASE DE DONNÃ‰ES
   âœ“ SQLite: sqlite3 /var/www/baikal/Specific/db/db.sqlite "PRAGMA integrity_check;"
   âœ“ MySQL: mysql -u baikal -p -e "SHOW TABLES;" baikal

CHECKLIST COMPLÃˆTE:
------------------
â–¡ Interface web accessible
â–¡ Connexion admin fonctionne
â–¡ Utilisateurs visibles
â–¡ Calendriers accessibles
â–¡ Contacts accessibles
â–¡ Logs sans erreurs critiques
â–¡ Services actifs
â–¡ Permissions correctes
â–¡ Synchronisation fonctionne
â–¡ Base de donnÃ©es intÃ¨gre

================================================================================
FRÃ‰QUENCE DES MISES Ã€ JOUR
================================================================================

RECOMMANDATIONS:
---------------
â€¢ VÃ©rifier les mises Ã  jour: Mensuellement
â€¢ Installer les mises Ã  jour de sÃ©curitÃ©: ImmÃ©diatement
â€¢ Installer les mises Ã  jour stables: Dans les 2 semaines
â€¢ Tester les prÃ©-releases: Uniquement en environnement de test

VERSIONS Ã€ PRIVILÃ‰GIER:
----------------------
âœ“ Versions stables (ex: 0.9.5, 0.9.4)
âš  Ã‰viter les prÃ©-releases en production
âš  Attendre quelques jours aprÃ¨s une nouvelle release pour les retours de la communautÃ©

================================================================================
RÃ‰SOLUTION DES PROBLÃˆMES COURANTS
================================================================================

PROBLÃˆME: Services ne dÃ©marrent pas aprÃ¨s mise Ã  jour
SOLUTION:
1. VÃ©rifier les logs: journalctl -u nginx -u php*-fpm
2. Tester la config Nginx: sudo nginx -t
3. VÃ©rifier les permissions: ls -la /var/www/baikal/
4. Si Ã©chec, restaurer le backup

PROBLÃˆME: Erreurs de base de donnÃ©es
SOLUTION:
1. VÃ©rifier l'intÃ©gritÃ© (SQLite): sqlite3 db.sqlite "PRAGMA integrity_check;"
2. VÃ©rifier les permissions du fichier DB
3. VÃ©rifier la config dans /var/www/baikal/Specific/config.php
4. Restaurer DB depuis backup si nÃ©cessaire

PROBLÃˆME: Interface web inaccessible
SOLUTION:
1. VÃ©rifier Nginx: systemctl status nginx
2. VÃ©rifier PHP-FPM: systemctl status php*-fpm
3. Tester en local: curl http://localhost/
4. VÃ©rifier les permissions: ls -la /var/www/baikal/html/

PROBLÃˆME: Synchronisation ne fonctionne plus
SOLUTION:
1. VÃ©rifier les URLs CalDAV/CardDAV sur les clients
2. VÃ©rifier les credentials
3. Tester avec curl: curl -u user:pass https://domain.com/dav.php/
4. VÃ©rifier les logs des clients
5. Reconfigurer le compte sur le client si nÃ©cessaire

================================================================================
NOTES IMPORTANTES
================================================================================

âš  DONNÃ‰ES PRÃ‰SERVÃ‰ES lors de la mise Ã  jour:
  â€¢ Tous les calendriers et Ã©vÃ©nements (Specific/db/)
  â€¢ Tous les contacts (Specific/db/)
  â€¢ Configuration utilisateurs (Specific/)
  â€¢ Configuration systÃ¨me (config/)

âš  DONNÃ‰ES REMPLACÃ‰ES lors de la mise Ã  jour:
  â€¢ Code source BaÃ¯kal (html/, Core/, vendor/)
  â€¢ Interface web d'administration
  â€¢ BibliothÃ¨ques PHP

âš  RECOMMANDATIONS:
  â€¢ Toujours crÃ©er un backup avant mise Ã  jour
  â€¢ Tester sur un environnement de dÃ©veloppement d'abord
  â€¢ Effectuer les mises Ã  jour pendant les heures creuses
  â€¢ Informer les utilisateurs avant la mise Ã  jour
  â€¢ Garder les backups pendant au moins 30 jours

================================================================================
SCRIPTS DISPONIBLES
================================================================================

update_baikal.sh       - Mise Ã  jour interactive complÃ¨te
check_updates.sh       - VÃ©rification rapide des mises Ã  jour disponibles
backup_baikal.sh       - Backup manuel avant mise Ã  jour
monitor_baikal.sh      - VÃ©rification post-mise Ã  jour

================================================================================
RESSOURCES
================================================================================

Documentation officielle: https://sabre.io/baikal/upgrade/
Releases GitHub: https://github.com/sabre-io/Baikal/releases
Changelog: https://github.com/sabre-io/Baikal/blob/master/CHANGELOG.md
Issues: https://github.com/sabre-io/Baikal/issues

================================================================================

Bonne mise Ã  jour ! ğŸš€
