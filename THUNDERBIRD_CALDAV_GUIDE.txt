################################################################################
#          GUIDE CONFIGURATION THUNDERBIRD AVEC BA√èKAL                         #
################################################################################

PROBL√àME RENCONTR√â
==================

Erreur dans Thunderbird lors de l'enregistrement d'un √©v√©nement:
  "une erreur s'est produite lors de l'√©criture dans l'agenda dav"
  Code d'erreur : MODIFICATION_FAILED

CAUSES POSSIBLES
================

1. URL CalDAV incorrecte ou incompl√®te
2. Calendrier configur√© en lecture seule
3. Probl√®mes de permissions c√¥t√© serveur
4. Cache Thunderbird corrompu
5. Probl√®me d'authentification

SOLUTION 1: DIAGNOSTIC SERVEUR (PRIORIT√â)
==========================================

Avant de toucher √† Thunderbird, v√©rifier que le serveur est OK:

cd ~/baikal-install
chmod +x diagnose_caldav_write.sh
sudo ./diagnose_caldav_write.sh

Ce script v√©rifie:
  ‚úì Permissions des fichiers
  ‚úì Acc√®s en √©criture √† la base
  ‚úì Pr√©sence des calendriers
  ‚úì Configuration PHP
  ‚úì Logs d'erreur

SI PROBL√àMES D√âTECT√âS:
  sudo ./fix_caldav_permissions.sh

SOLUTION 2: V√âRIFIER L'URL CALDAV
==================================

L'URL doit √™tre COMPL√àTE et EXACTE.

FORMAT CORRECT:
  https://caldav.maison-oadf.ddns.net/dav.php/calendars/[utilisateur]/[calendrier]/

EXEMPLES:
  ‚úì https://caldav.maison-oadf.ddns.net/dav.php/calendars/admin/default/
  ‚úì https://caldav.maison-oadf.ddns.net/dav.php/calendars/john/travail/
  ‚úó https://caldav.maison-oadf.ddns.net/  (incomplet)
  ‚úó https://caldav.maison-oadf.ddns.net/dav.php  (incomplet)

COMMENT TROUVER L'URL EXACTE:
-----------------------------

1. Se connecter √† l'interface admin Ba√Økal:
   https://caldav.maison-oadf.ddns.net/admin/

2. Aller dans "Utilisateurs & Ressources"

3. Cliquer sur votre utilisateur

4. Sous "Calendriers", vous verrez l'URL exacte de chaque calendrier
   Exemple: calendars/admin/default/

5. Composer l'URL compl√®te:
   https://caldav.maison-oadf.ddns.net/dav.php/calendars/admin/default/

ATTENTION: Le "/" final est IMPORTANT !

SOLUTION 3: RECONFIGURER LE CALENDRIER DANS THUNDERBIRD
========================================================

Si l'URL est correcte mais le probl√®me persiste, recr√©er le calendrier.

√âTAPES D√âTAILL√âES:

1. SUPPRIMER L'ANCIEN CALENDRIER
   -------------------------------
   Dans Thunderbird:
   - Aller dans l'onglet "Agenda"
   - Clic droit sur le calendrier probl√©matique
   - S√©lectionner "Supprimer le calendrier"
   - Confirmer

2. AJOUTER UN NOUVEAU CALENDRIER
   ------------------------------
   - Clic droit dans la liste des calendriers (√† gauche)
   - "Nouveau calendrier..."
   - S√©lectionner "Sur le r√©seau"
   - Clic sur "Suivant"

3. CHOISIR LE TYPE
   ---------------
   - S√©lectionner "CalDAV"
   - Ne PAS cocher "D√©tecter automatiquement"

4. ENTRER LES INFORMATIONS
   ------------------------
   Utilisateur: [votre_utilisateur_baikal]
   
   Emplacement: https://caldav.maison-oadf.ddns.net/dav.php/calendars/[utilisateur]/[calendrier]/
   
   ‚ö†Ô∏è IMPORTANT: Remplacez [utilisateur] et [calendrier] par les valeurs r√©elles !
   
   Exemple:
   Utilisateur: admin
   Emplacement: https://caldav.maison-oadf.ddns.net/dav.php/calendars/admin/default/

5. AUTHENTIFICATION
   ----------------
   - Thunderbird demandera le mot de passe
   - Entrer le mot de passe Ba√Økal
   - ‚òë Cocher "Utiliser le gestionnaire de mots de passe"

6. PROPRI√âT√âS DU CALENDRIER
   -------------------------
   Une fois cr√©√©:
   - Clic droit sur le calendrier
   - "Propri√©t√©s"
   - V√©rifier:
     ‚òë "Activer ce calendrier"
     ‚òë "En lecture et en √©criture" (PAS lecture seule !)
     ‚òë "Afficher les alarmes"
   - Clic sur "OK"

7. TESTER
   ------
   - Cr√©er un nouvel √©v√©nement
   - L'enregistrer
   - V√©rifier qu'il n'y a plus d'erreur
   - L'√©v√©nement devrait appara√Ætre dans Ba√Økal web

SOLUTION 4: VIDER LE CACHE THUNDERBIRD
=======================================

Si le probl√®me persiste apr√®s reconfiguration:

WINDOWS:
--------
1. Fermer compl√®tement Thunderbird
2. Appuyer sur Win+R
3. Taper: %APPDATA%\Thunderbird\Profiles\
4. Ouvrir le dossier de votre profil (ex: xxxxxxxx.default)
5. Supprimer les fichiers:
   - calendar-data/
   - storage.sdb
6. Relancer Thunderbird

LINUX:
------
1. Fermer compl√®tement Thunderbird
2. Ouvrir un terminal
3. cd ~/.thunderbird/
4. ls  # Trouver votre profil
5. cd xxxxxxxx.default/
6. rm -rf calendar-data/
7. rm -f storage.sdb
8. Relancer Thunderbird

MAC:
----
1. Fermer compl√®tement Thunderbird
2. Ouvrir Finder
3. Aller √† ~/Library/Thunderbird/Profiles/
4. Ouvrir votre profil
5. Supprimer calendar-data/
6. Relancer Thunderbird

SOLUTION 5: TESTER AVEC CURL
=============================

Pour v√©rifier que le serveur accepte les modifications:

# Test de lecture (PROPFIND)
curl -u 'utilisateur:motdepasse' -X PROPFIND \
  -H 'Depth: 1' \
  https://caldav.maison-oadf.ddns.net/dav.php/calendars/utilisateur/default/

# Test d'√©criture (PUT - cr√©er un √©v√©nement)
curl -u 'utilisateur:motdepasse' -X PUT \
  -H 'Content-Type: text/calendar; charset=utf-8' \
  -d 'BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
UID:test-event-12345@caldav.maison-oadf.ddns.net
DTSTAMP:20251224T120000Z
DTSTART:20251225T100000Z
DTEND:20251225T110000Z
SUMMARY:Test √©v√©nement
END:VEVENT
END:VCALENDAR' \
  https://caldav.maison-oadf.ddns.net/dav.php/calendars/utilisateur/default/test-event-12345.ics

Remplacez 'utilisateur' et 'motdepasse' par vos identifiants.

R√âSULTATS ATTENDUS:
  - 200 ou 201 = Succ√®s
  - 401 = Erreur d'authentification
  - 403 = Permissions insuffisantes
  - 500 = Erreur serveur

SOLUTION 6: V√âRIFIER LES LOGS SERVEUR
======================================

Pendant que vous essayez de cr√©er un √©v√©nement dans Thunderbird,
surveillez les logs en temps r√©el:

sudo tail -f /var/log/nginx/baikal_error.log

Vous verrez imm√©diatement les erreurs qui se produisent.

ERREURS COURANTES:

"Permission denied" ‚Üí Probl√®me de permissions
  Solution: sudo ./fix_caldav_permissions.sh

"404 Not Found" ‚Üí URL incorrecte
  Solution: V√©rifier l'URL du calendrier

"401 Unauthorized" ‚Üí Probl√®me d'authentification
  Solution: V√©rifier identifiant/mot de passe

"500 Internal Server Error" ‚Üí Probl√®me PHP/Base
  Solution: Consulter les logs PHP

SOLUTION 7: PERMISSIONS LECTURE SEULE
======================================

Si le calendrier est marqu√© comme "Lecture seule" dans Thunderbird:

1. Clic droit sur le calendrier dans Thunderbird
2. "Propri√©t√©s"
3. V√©rifier que "En lecture et en √©criture" est s√©lectionn√©
4. Si "Lecture seule" est gris√©, le calendrier est configur√© c√¥t√© serveur
5. Aller dans Ba√Økal admin et v√©rifier les droits de l'utilisateur

CONFIGURATION AVANC√âE THUNDERBIRD
==================================

Pour am√©liorer la synchronisation:

1. Ouvrir les Pr√©f√©rences Thunderbird
2. Aller dans "Agenda" ou "Calendar"
3. Param√®tres de synchronisation:
   - Intervalle de synchronisation: 5-10 minutes
   - Activer les notifications d'√©v√©nements

THUNDERBIRD + THUNDERBIRD POUR ANDROID
=======================================

Si vous utilisez aussi Thunderbird sur Android:

1. Installer "Thunderbird" depuis Google Play
2. Ajouter le calendrier:
   - Menu > Param√®tres > Calendriers
   - Ajouter un calendrier
   - CalDAV
   - M√™me URL que sur desktop
3. Entrer les identifiants

ALTERNATIVE: DAVX5 (PLUS STABLE SUR ANDROID)
---------------------------------------------

DAVx5 est souvent plus stable que Thunderbird Android:

1. Installer DAVx5 depuis F-Droid ou Google Play
2. Ajouter un compte:
   - URL de base: https://caldav.maison-oadf.ddns.net/dav.php
   - Utilisateur et mot de passe
3. Synchroniser calendriers et contacts
4. Utiliser l'app Calendrier syst√®me Android

CHECKLIST DE D√âPANNAGE
=======================

‚òê Serveur diagnostiqu√© (./diagnose_caldav_write.sh)
‚òê Permissions corrig√©es si n√©cessaire (./fix_caldav_permissions.sh)
‚òê URL CalDAV compl√®te et correcte (avec / final)
‚òê Calendrier configur√© "Lecture et √©criture" (pas lecture seule)
‚òê Cache Thunderbird vid√©
‚òê Test curl r√©ussi
‚òê Logs serveur sans erreurs
‚òê Authentification valide
‚òê Calendrier recr√©√© dans Thunderbird

RESSOURCES SUPPL√âMENTAIRES
===========================

Documentation Ba√Økal:
  https://sabre.io/baikal/

Documentation Thunderbird CalDAV:
  https://support.mozilla.org/kb/using-lightning-calendar

Tests CalDAV en ligne:
  https://www.caldavtester.org/

Si apr√®s TOUTES ces √©tapes le probl√®me persiste:
  - Consulter les forums Ba√Økal
  - V√©rifier les issues GitHub: https://github.com/sabre-io/Baikal/issues
  - Fournir les logs complets

================================================================================

COMMANDE RAPIDE POUR TOUT CORRIGER
===================================

# 1. Diagnostic
sudo ./diagnose_caldav_write.sh

# 2. Correction permissions (si n√©cessaire)
sudo ./fix_caldav_permissions.sh

# 3. Obtenir l'URL exacte du calendrier
Se connecter √†: https://caldav.maison-oadf.ddns.net/admin/

# 4. Reconfigurer dans Thunderbird avec l'URL compl√®te

================================================================================

Bonne synchronisation ! üìÖ
