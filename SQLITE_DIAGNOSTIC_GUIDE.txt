################################################################################
#       GUIDE PRIORITAIRE: DIAGNOSTIC BASE DE DONN√âES SQLITE                  #
################################################################################

üî¥ PROBL√àME D√âTECT√â
===================

Le monitoring a signal√© un probl√®me d'int√©grit√© de la base de donn√©es SQLite.

MESSAGE:
  Base de donn√©es:
  ‚úì SQLite: Base trouv√©e (108K)
    Int√©grit√©: Probl√®me d√©tect√©

‚ö†Ô∏è IMPORTANT: Cela peut √™tre un FAUX POSITIF !
   Le script de monitoring avait un bug de d√©tection.

√âTAPE 1: DIAGNOSTIC IMM√âDIAT (30 secondes)
===========================================

cd ~/baikal-install
chmod +x diagnose_sqlite_db.sh
sudo ./diagnose_sqlite_db.sh

Ce script va v√©rifier en profondeur:
  ‚úì Int√©grit√© globale (PRAGMA integrity_check)
  ‚úì V√©rification rapide (PRAGMA quick_check)
  ‚úì Structure des tables
  ‚úì Cl√©s √©trang√®res
  ‚úì Lecture/√©criture

R√âSULTATS POSSIBLES:

1. ‚úÖ BASE DE DONN√âES EN BON √âTAT
   ‚Üí C'√©tait un FAUX POSITIF du monitoring
   ‚Üí Aucune action n√©cessaire
   ‚Üí Le nouveau script de monitoring est corrig√©

2. ‚ùå PROBL√àME D√âTECT√â DANS LA BASE
   ‚Üí Passez √† l'√âTAPE 2 (R√©paration)

√âTAPE 2: R√âPARATION (si n√©cessaire)
====================================

Si le diagnostic confirme un probl√®me r√©el:

cd ~/baikal-install
chmod +x repair_sqlite_db.sh
sudo ./repair_sqlite_db.sh

Le script tentera 3 m√©thodes de r√©paration:
  1. REINDEX - Reconstruction des index
  2. VACUUM - Nettoyage et compaction
  3. Export/Import - Reconstruction compl√®te

Un backup sera cr√©√© AVANT toute modification:
  /var/backups/baikal/db_repair/db.sqlite.before_repair.YYYYMMDD_HHMMSS

√âTAPE 3: NOUVEAU MONITORING CORRIG√â
====================================

Le script de monitoring original avait un bug dans la d√©tection d'int√©grit√©
SQLite (retour √† la ligne non nettoy√©).

REMPLACER LE SCRIPT:
cd ~/baikal-install
mv monitor_baikal.sh monitor_baikal.sh.old
cp monitor_baikal_fixed.sh monitor_baikal.sh
chmod +x monitor_baikal.sh

TESTER:
sudo ./monitor_baikal.sh

Vous devriez maintenant voir:
  Base de donn√©es:
  ‚úì SQLite: Base trouv√©e (108K)
    Int√©grit√©: OK  ‚Üê Corrig√© !

COMPRENDRE LE BUG DU MONITORING
================================

LE PROBL√àME:
Le script faisait:
  INTEGRITY=$(sqlite3 db.sqlite "PRAGMA integrity_check;")
  if [ "$INTEGRITY" = "ok" ]; then

Mais si SQLite retourne "ok\n" (avec retour √† la ligne),
le test √©choue et affiche "Probl√®me d√©tect√©" alors que tout va bien.

LA CORRECTION:
  INTEGRITY=$(sqlite3 db.sqlite "PRAGMA integrity_check;" | tr -d '\n\r' | xargs)
  if [ "$INTEGRITY" = "ok" ]; then

Maintenant on nettoie les retours √† la ligne avant le test.

V√âRIFICATION MANUELLE DE LA BASE
=================================

Si vous voulez v√©rifier manuellement:

# 1. Test d'int√©grit√©
sqlite3 /var/www/baikal/Specific/db/db.sqlite "PRAGMA integrity_check;"
# Doit retourner: ok

# 2. Test rapide
sqlite3 /var/www/baikal/Specific/db/db.sqlite "PRAGMA quick_check;"
# Doit retourner: ok

# 3. Lister les tables
sqlite3 /var/www/baikal/Specific/db/db.sqlite ".tables"
# Doit afficher: addressbooks calendars principals, etc.

# 4. Compter les enregistrements
sqlite3 /var/www/baikal/Specific/db/db.sqlite "SELECT COUNT(*) FROM calendars;"
# Doit retourner un nombre

Si toutes ces commandes fonctionnent ‚Üí Base OK !

SC√âNARIOS ET ACTIONS
=====================

SC√âNARIO 1: Diagnostic dit "Base OK"
------------------------------------
‚úÖ Parfait ! C'√©tait juste un bug du monitoring.

Actions:
  1. Remplacer monitor_baikal.sh par la version corrig√©e
  2. Relancer le monitoring
  3. Tout devrait √™tre vert

SC√âNARIO 2: Diagnostic d√©tecte un vrai probl√®me
------------------------------------------------
üî¥ Action imm√©diate requise

Actions:
  1. Le script de diagnostic propose de cr√©er un backup ‚Üí Accepter
  2. Lancer repair_sqlite_db.sh
  3. Le script tentera 3 m√©thodes de r√©paration
  4. Si r√©paration r√©ussie ‚Üí V√©rifier que Ba√Økal fonctionne
  5. Si √©chec ‚Üí Restaurer depuis un backup

SC√âNARIO 3: R√©paration √©choue
------------------------------
üÜò Restauration n√©cessaire

Actions:
  1. Lister les backups disponibles:
     ls -lth /var/backups/baikal/

  2. Extraire un backup r√©cent:
     cd /tmp
     sudo tar -xzf /var/backups/baikal/baikal_YYYYMMDD.tar.gz

  3. Restaurer juste la base de donn√©es:
     sudo cp var/www/baikal/Specific/db/db.sqlite /var/www/baikal/Specific/db/
     sudo chown www-data:www-data /var/www/baikal/Specific/db/db.sqlite
     sudo chmod 660 /var/www/baikal/Specific/db/db.sqlite

  4. Red√©marrer les services:
     sudo systemctl restart nginx php8.3-fpm

  5. Tester Ba√Økal dans le navigateur

PR√âVENTION
==========

Pour √©viter les probl√®mes futurs:

1. BACKUPS R√âGULIERS (d√©j√† configur√© ‚úì)
   - Automatique via cron
   - R√©tention: 30 jours
   - V√©rifier: ls /var/backups/baikal/

2. MONITORING R√âGULIER
   - Lancer monitor_baikal.sh chaque semaine
   - V√©rifier les alertes

3. MISES √Ä JOUR
   - Garder Ba√Økal √† jour
   - Utiliser update_baikal_v2.sh

4. NE PAS √âDITER LA BASE MANUELLEMENT
   - Ne jamais modifier db.sqlite √† la main
   - Toujours passer par l'interface Ba√Økal

FICHIERS DISPONIBLES
=====================

diagnose_sqlite_db.sh    ‚Üí Diagnostic complet (√âTAPE 1)
repair_sqlite_db.sh      ‚Üí R√©paration automatique (√âTAPE 2)
monitor_baikal_fixed.sh  ‚Üí Monitoring corrig√© (√âTAPE 3)

COMMANDES RAPIDES
=================

# Diagnostic complet
sudo ./diagnose_sqlite_db.sh

# R√©paration (si probl√®me confirm√©)
sudo ./repair_sqlite_db.sh

# Nouveau monitoring
sudo ./monitor_baikal_fixed.sh

# V√©rification manuelle rapide
sqlite3 /var/www/baikal/Specific/db/db.sqlite "PRAGMA integrity_check;"

# Liste des backups
ls -lth /var/backups/baikal/

CAS D'URGENCE
=============

Si Ba√Økal ne fonctionne plus DU TOUT:

1. Arr√™ter les services
   sudo systemctl stop nginx php8.3-fpm

2. Restaurer le dernier backup complet
   cd /var/backups/baikal
   LATEST=$(ls -t baikal_*.tar.gz | head -1)
   sudo tar -xzf "$LATEST" -C /

3. Red√©marrer
   sudo systemctl start php8.3-fpm nginx

4. Tester
   curl https://caldav.maison-oadf.ddns.net/

EN R√âSUM√â
=========

üéØ PRIORIT√â 1: Lancer diagnose_sqlite_db.sh
   ‚Üí D√©termine si c'est un vrai probl√®me ou un faux positif

üîß SI PROBL√àME: Lancer repair_sqlite_db.sh
   ‚Üí Tente de r√©parer automatiquement

‚úÖ SI OK: Remplacer monitor_baikal.sh
   ‚Üí √âvite les fausses alertes futures

üíæ TOUJOURS: V√©rifier les backups r√©guliers
   ‚Üí S√©curit√© en cas de probl√®me

================================================================================

Commencez par: sudo ./diagnose_sqlite_db.sh

Cela prend 30 secondes et vous dira exactement ce qu'il en est ! üîç
